{% extends 'layouts/base.html' %}
{% load static %}
{% block breadcrumbs %}{% endblock breadcrumbs %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<div id="app-gastos-movil" class="container mt-4">
    <div class="row mb-2">
        <div class="col-md-6">
            <input v-model="searchQuery" @input="onSearch" class="form-control" placeholder="Buscar por móvil, cliente o descripción" />
        </div>
        <div class="col-md-6 text-right">
            <button class="btn btn-primary" @click="openModal('add')"><i class="fas fa-plus"></i> Agregar Gasto</button>
        </div>
    </div>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Móvil</th>
                <th>Centro Costos</th>
                <th>Área</th>
                <th>Descripción</th>
                <th>Importe</th>
                <th>Comprobante</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="gasto in gastos_movil" :key="gasto.id">
                <td>[[ formatDate(gasto.fecha) ]]</td>
                <td>[[ gasto.cliente_nombre ]]</td>
                <td>[[ gasto.movil_patente ]]</td>
                <td>[[ gasto.centro_costos_descripcion ]]</td>
                <td>[[ gasto.area_nombre ]]</td>
                <td>[[ gasto.descripcion ]]</td>
                <td>[[ gasto.importe ]]</td>
                <td>[[ gasto.comprobante ]]</td>
                <td>
                    <button class="btn btn-warning btn-sm" @click="openModal('edit', gasto)">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" @click="deleteGastoMovil(gasto.id)">
                        <i class="fas fa-trash"></i> 
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    <nav aria-label="Page navigation example">
        <ul class="pagination">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click="prevPage">Anterior</a>
            </li>
            <li v-for="page in totalPages" :key="page" class="page-item" :class="{ active: currentPage === page }">
                <a class="page-link" href="#" @click="goToPage(page)">[[ page ]]</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click="nextPage">Siguiente</a>
            </li>
        </ul>
    </nav>
    <!-- Modal para Agregar/Editar Gastos de Móvil -->
    <div class="modal" tabindex="-1" role="dialog" id="modal-form">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">[[ modalTitle ]]</h5>
                    <button type="button" class="close" @click="closeModal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveGastoMovil">
                        <div class="form-group">
                            <label for="movil">Móvil</label>
                            <select v-model="formData.movil" class="form-control" required>
                                <option value="">-- Seleccione un Móvil --</option>
                                <option v-for="movil in moviles" :key="movil.id" :value="movil.id">[[ movil.patente ]]</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cliente">Cliente</label>
                            <select v-model="formData.cliente" class="form-control">
                                <option value="">-- Seleccione un Cliente --</option>
                                <option v-for="cliente in clientes" :key="cliente.id" :value="cliente.id">[[ cliente.nombre ]]</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="centro_costos">Centro de Costos</label>
                            <select v-model="formData.centro_costos" class="form-control" required>
                                <option value="">-- Seleccione un Centro de Costos --</option>
                                <option v-for="centro in centros_costos" :key="centro.id" :value="centro.id">[[ centro.descripcion ]]</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="area">Área</label>
                            <select v-model="formData.area" class="form-control">
                                <option value="">-- Seleccione un Área --</option>
                                <option v-for="area in filteredAreas" :key="area.id" :value="area.id">[[ area.detalle ]]</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fecha">Fecha</label>
                            <input v-model="formData.fecha" class="form-control" type="date" required>
                        </div>                        
                        <div class="form-group">
                            <label for="descripcion">Descripción</label>
                            <input v-model="formData.descripcion" class="form-control" type="text" required>
                        </div>
                        <div class="form-group">
                            <label for="importe">Importe</label>
                            <input v-model="formData.importe" class="form-control" type="number" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="litros">Litros</label>
                            <input v-model="formData.litros" class="form-control" type="number" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="comprobante">Comprobante</label>
                            <input v-model="formData.comprobante" class="form-control" type="text">
                        </div>
                        <button type="submit" class="btn btn-success">[[ modalButtonLabel ]]</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
 new Vue({
    el: '#app-gastos-movil',
    delimiters: ['[[', ']]'],
    data() {
        return {
            gastos_movil: [], 
            searchQuery: '',
            formData: {
                id: null,
                movil: '',
                cliente: '',
                centro_costos: '',
                area: '',
                fecha: '',
                descripcion: '',
                importe: '',
                litros: '',
                comprobante: ''
            },
            modalTitle: '',
            modalButtonLabel: '',
            moviles: [],
            clientes: [],
            centros_costos: [],
            areas: [],
            currentPage: 1,
            pageSize: 10,
            totalItems: 0
        };
    },
    computed: {
        totalPages() {
            return Math.ceil(this.totalItems / this.pageSize);
        },
        // Computed property to filter areas based on selected client
        filteredAreas() {
            // If no client is selected, return an empty array
            if (!this.formData.cliente) {
                return [];
            }
            // Filter areas where the 'cliente' property matches the selected formData.cliente
            // **NOTE:** This assumes your 'areas' data fetched from '/syh/api/areas/' includes a 'cliente' property (or similar, like 'cliente_id')
            // If your areas API response structure is different, you might need to adjust the filtering logic here.
            return this.areas.filter(area => area.cliente === this.formData.cliente);
        }
    },
    mounted() {
        this.fetchGastosMovil();
        this.loadMoviles();
        this.loadClientes();
        this.loadCentrosCostos();
        this.loadAreas();
    },
    methods: {
        onSearch() {
            this.currentPage = 1;
            this.fetchGastosMovil();
        },
        fetchGastosMovil(page = this.currentPage) {
            const params = {
                page: page,
                page_size: this.pageSize,
                search: this.searchQuery
            };
            axios.get(`/moviles/api/gastos_movil/`, { params })
                .then(response => {
                    if (response.data && typeof response.data === 'object') {
                        this.gastos_movil = Array.isArray(response.data.results) ? response.data.results : [];
                        this.totalItems = response.data.count || 0;
                        this.currentPage = response.data.current_page || 1;
                    } else {
                        console.error('Formato de respuesta inesperado:', response.data);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar los gastos de móvil:', error);
                });
        },
        openModal(action, gasto = null) {
            if (action === 'add') {
                this.modalTitle = 'Agregar Gasto de Móvil';
                this.modalButtonLabel = 'Agregar';
                this.formData = {
                    id: null,
                    movil: '',
                    cliente: '',
                    centro_costos: '',
                    area: '',
                    fecha: new Date().toISOString().split('T')[0],
                    descripcion: '',
                    importe: '',
                    litros: '',
                    comprobante: ''
                };
            } else if (action === 'edit' && gasto) {
                this.modalTitle = 'Editar Gasto de Móvil';
                this.modalButtonLabel = 'Guardar Cambios';
                
                this.formData = {
                    id: gasto.id || null,
                    movil: gasto.movil || null,
                    cliente: gasto.cliente || null,
                    centro_costos: gasto.centro_costos || null,
                    area: gasto.area || null,
                    fecha: gasto.fecha || '',
                    descripcion: gasto.descripcion || '',
                    importe: gasto.importe || '',
                    litros: gasto.litros || '',
                    comprobante: gasto.comprobante || ''
                };
            }
            $('#modal-form').modal('show');
        },
        closeModal() {
            $('#modal-form').modal('hide');
        },
        saveGastoMovil() {
            if (!this.formData) {
                toastr.error('Datos del formulario no válidos');
                return;
            }
            const url = this.formData.id ? 
                `/moviles/api/gastos_movil/${this.formData.id}/` : 
                '/moviles/api/gastos_movil/';
            const method = this.formData.id ? 'PUT' : 'POST';
            
            const csrfElement = document.querySelector('[name=csrf-token]');
            if (!csrfElement) {
                toastr.error('Error: Token CSRF no encontrado');
                return;
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfElement.content,
                },
                body: JSON.stringify(this.formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                this.fetchGastosMovil();
                this.closeModal();
                toastr.success('Registro guardado correctamente.');
            })
            .catch(error => {
                toastr.error(`Error: ${error.message}`);
            });
        },
        deleteGastoMovil(id) {
            if (!id) {
                toastr.error('ID no válido');
                return;
            }
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const csrfElement = document.querySelector('[name=csrf-token]');
                    if (!csrfElement) {
                        toastr.error('Error: Token CSRF no encontrado');
                        return;
                    }
                    fetch(`/moviles/api/gastos_movil/${id}/`, { 
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfElement.content,
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al eliminar el registro.');
                        }
                        this.fetchGastosMovil();
                        toastr.success('Registro eliminado correctamente.');
                    })
                    .catch(error => {
                        toastr.error(`Error: ${error.message}`);
                    });
                }
            });
        },
        loadMoviles() {
            axios.get('/moviles/api/movil/')
                .then(response => {
                    this.moviles = response.data.results || [];
                })
                .catch(error => {
                    console.error('Error al cargar móviles:', error);
                });
        },
        loadClientes() {
            axios.get('/syh/api/clientes/')
                .then(response => {
                    this.clientes = response.data || [];
                    console.log(response);
                })
                .catch(error => {
                    console.error('Error al cargar clientes:', error);
                });
        },
        loadCentrosCostos() {
            axios.get('/moviles/api/centro_costos/')
                .then(response => {
                    this.centros_costos = response.data.results || [];
                })
                .catch(error => {
                    console.error('Error al cargar centros de costos:', error);
                });
        },
        loadAreas() {
            axios.get('/syh/api/areas/')
                .then(response => {
                    this.areas = response.data.results || [];
                })
                .catch(error => {
                    console.error('Error al cargar áreas:', error);
                });
        },
        // New method triggered when the client selection changes
        onClienteChange() {
             console.log("Cliente selected:", this.formData.cliente);
             // Reset the selected area when the client changes
             this.formData.area = null;
             // The computed property `filteredAreas` will automatically update
             // based on the new `this.formData.cliente` value.
        },
        formatDate(date) {
            if (!date) return '';
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(date).toLocaleDateString('es-ES', options);
        },
        goToPage(page) {
            if (page >= 1 && page <= this.totalPages) {
                this.currentPage = page;
                this.fetchGastosMovil(page);
            }
        },
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.fetchGastosMovil(this.currentPage);
            }
        },
        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.fetchGastosMovil(this.currentPage);
            }
        }
    }
});
</script>
{% endblock %}