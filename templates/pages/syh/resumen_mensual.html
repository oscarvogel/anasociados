{% extends 'layouts/base.html' %}
{% load static %}

{% block breadcrumbs %}{% endblock breadcrumbs %}

{% block content %}
<div class="container">
    <h3>Resumen Mensual</h3>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <select id="cliente-select" class="form-control">
                        <option value="">--Selecciona un cliente--</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" {% if cliente.id == cliente_id_selected %}selected{% endif %}>
                            {{ cliente.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row">
                <button type="button" id="resumen-button" class="btn btn-secondary" onclick="iniciarTarea()">Generar</button>
                <div class="progress mt-3 container" >
                    <div id="progress-bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="progress mt-3" id="task-progress"> 
        </div>
        <hr>
        <h5 class="text-center">Descargar archivos</h5>
        <div class="row" id="descarga-archivos" style="display: none;">
            <div class="col-md-6">
                {% comment %} <a class="btn btn-primary" href="{% url 'syh:download_file' 'resumen_mensual.pdf' %}" download>Descargar archivo</a> {% endcomment %}
                <a class="btn btn-primary" href="#" id="download-link" download>Descargar archivo</a>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    //implementacion del boton de resumen
    {% comment %} document.getElementById('resumen-button').addEventListener('click', function() {
        const clienteId = document.getElementById('cliente-select').value;
        if (clienteId) {
            window.location.href = `{% url 'syh:generar_resumen' %}?cliente=${clienteId}`;
        } else {
            alert('Por favor selecciona un cliente');
        }
    }); {% endcomment %}
    function mostrarDivDescarga() { 
        document.getElementById('descarga-archivos').style.display = 'block';
    }

    function iniciarTarea() {
        var clienteId = document.getElementById('cliente-select').value
        $.ajax({
            url: "{% url 'syh:generar_resumen'  %}?cliente=" + clienteId,
            type: "GET",
            success: function(response) {
                consultarEstado(response.task_id);
            }
        });
    }

    function consultarEstado(task_id) {
        $.ajax({
            url: "{% url 'syh:progreso_tarea' 'task_id_placeholder' %}".replace('task_id_placeholder', task_id),
            type: "GET",
            success: function(response) {
                //console.log(response);
                if (response.state === 'SUCCESS') {
                    $('#progress-bar').css('width', '100%').attr('aria-valuenow', 100);
                    // Mostrar el div de descarga 
                    mostrarDivDescarga(); 
                    // Actualizar el enlace de descarga con la URL del PDF generado
                    var downloadLink = document.getElementById('download-link');
                    var pdfFilename = response.pdf_file.split('/').pop();
                    downloadLink.href = "{% url 'syh:download_file' 'pdf_file_placeholder' %}".replace('pdf_file_placeholder', pdfFilename);
                    downloadLink.download = pdfFilename;

                    // Opcional: Descargar el PDF autom√°ticamente
                    downloadLink.click();
                } else if (response.state === 'FAILURE') {
                    //progress-bar.innerHTML += `<p class="danger">Error: ${response.message}</p>`;
                    console.log(response.message);
                }else {
                    var progreso = (response.current / response.total) * 100;
                    $('#progress-bar').css('width', progreso + '%').attr('aria-valuenow', progreso);
                    setTimeout(function() {
                        consultarEstado(task_id);
                    }, 1000);
                }
            }
        });
    }
</script>
{% endblock extra_js %}